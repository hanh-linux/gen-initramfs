#!/bin/bash

eval "$*"

[ -z "$kver" ] && kver=$(uname -r)
[ -z "$sysroot" ] && sysroot=/
[ ! -z "$bin" ] && bin=$(echo $bin | sed "s/,/ /g")
[ ! -z "$lib" ] && lib=$(echo $lib | sed "s/,/ /g")
[ ! -z "$hooks" ] && hooks=$(echo $hooks | sed "s/,/ /g")

work=$(pwd)/workdir

mkdir -p $work
cd $work 

echo ">> (1/4) Working on essential files..."
cp -r $sysroot/usr/share/gen-initramfs/busybox-initramfs/* .
mkdir -p hooks hooks-before hooks-after bin etc usr/lib sbin usr/bin usr/sbin lib/modules/$kver/ var tmp run sys proc dev lib64 mnt opt root var

mknod -m 640 dev/console c 5 1
mknod -m 664 dev/null    c 1 3

cp $sysroot/usr/lib/libc.so usr/lib/
cp $sysroot/lib/ld-musl-x86_64.so.1 lib/
cp $sysroot/lib/libblkid.so.* lib/
cp $sysroot/usr/lib/libkmod.so* usr/lib
cp $sysroot/usr/lib/libcurses.so* usr/lib
cp $sysroot/usr/lib/libterminfo.so* usr/lib
cp $sysroot/usr/lib/liblzma.so.* usr/lib

cp -r $sysroot/usr/lib/udev/ usr/lib/ 

cp -F $sysroot/usr/sbin/udevd usr/bin 
cp -F $sysroot/usr/bin/udevadm usr/bin
cp -F $sysroot/sbin/kmod sbin/ 

cd $work/sbin
for x in depmod lsmod rmmod modprobe modinfo; do
ln -sf kmod $x 
done

cd $work
cp $sysroot/sbin/blkid bin/

for x in $bin; do
 cp $sysroot/$x ./$x
done

for x in $lib; do
 cp $sysroot/$x ./$x
done

for x in $hooks; do 
[ -f $sysroot/usr/share/gen-initramfs/hooks/$x.before ] && install -Dm755 $sysroot/usr/share/gen-initramfs/hooks/$x.before ./hooks-before/$x
[ -f $sysroot/usr/share/gen-initramfs/hooks/$x ] && install -Dm755 $sysroot/usr/share/gen-initramfs/hooks/$x ./hooks/$x
[ -f $sysroot/usr/share/gen-initramfs/hooks/$x.after ] && install -Dm755 $sysroot/usr/share/gen-initramfs/hooks/$x.after ./hooks/$x.after
sh $sysroot/usr/share/gen-initramfs/hooks/$x.sh
done

echo ">> (2/4) Copying modules..."
cp -r $sysroot/lib/modules/$kver/kernel/ lib/modules/$kver/kernel
cp -r $sysroot/lib/modules/$kver/modules.* lib/modules/$kver/

echo ">> (3/4) Copying init file..."
cp -r $sysroot/usr/share/gen-initramfs/init.in ./init

echo ">> (4/4) Generating initramfs..."
find . | cpio -o -H newc | gzip -6 > initramfs-$kver.img
